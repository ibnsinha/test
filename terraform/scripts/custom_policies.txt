#!/bin/bash

# Ensure Terraform is initialized
terraform init -input=false

# Loop through the customer_managed_policies map to generate terraform import commands
for policy_key in $(terraform console -no-color <<EOF
keys(var.customer_managed_policies)
EOF
); do
  # Extract the ARN for the current policy using terraform console
  policy_arn=$(terraform console -no-color <<EOF
var.customer_managed_policies["$policy_key"].arn
EOF
  )

  # Check if policy_arn is empty (error check)
  if [ -z "$policy_arn" ]; then
    echo "Error: ARN for policy $policy_key is empty!"
    continue
  fi

  # Generate terraform import command for each policy
  echo "Importing policy $policy_arn..."
  terraform import aws_iam_policy.customer_managed["$policy_key"] "$policy_arn"
done


==============


#!/bin/bash

# Define the IAM role name
role_name="my-iam-role"

# Check if the role exists (assuming role_exists is a variable that stores true/false)
if [ "$role_exists" == "true" ]; then
  echo "IAM Role $role_name exists. Proceeding with import..."

  # Get the list of attached policy ARNs to the IAM role (if any)
  policy_arns=$(aws iam list-attached-role-policies --role-name "$role_name" | jq -r '.AttachedPolicies[].PolicyArn')

  # Check if there are any attached policies
  if [ -n "$policy_arns" ]; then
    echo "The IAM role has attached policies. Importing role and policies..."

    # Import the IAM role
    terraform import aws_iam_role.my_role_name "$role_name"
    
    # Initialize an index counter for policy imports
    index=0

    # Loop through each policy ARN and import the attached policy
    for policy_arn in $policy_arns; do
      echo "Importing policy attachment: $policy_arn"
      terraform import aws_iam_role_policy_attachment.my_role_policy_attachment["$index"] "$role_name-$policy_arn"
      index=$((index + 1))
    done
  else
    echo "The IAM role has no attached policies. Only importing the IAM role."
    terraform import aws_iam_role.my_role_name "$role_name"
  fi
else
  echo "IAM Role $role_name does not exist. Skipping import."
fi


=============




#!/bin/bash

# Define IAM Role Name
role_name="my-iam-role"

# Fetch attached policy ARNs for the IAM role
policy_arns=$(aws iam list-attached-role-policies --role-name "$role_name" | jq -r '.AttachedPolicies[].PolicyArn')

# Check if any policies are attached
if [ -z "$policy_arns" ]; then
  echo "⚠️ No attached policies found for IAM role '$role_name'."
else
  echo "✅ Found attached policies for IAM role '$role_name'. Importing..."
  
  # Initialize index for Terraform import
  index=0

  # Loop through each policy ARN and import it in Terraform
  for policy_arn in $policy_arns; do
    echo "🔄 Importing policy attachment: $policy_arn"
    
    # Terraform import command
    terraform import aws_iam_role_policy_attachment.customer_policy_attachments["$index"] "$role_name/$policy_arn"

    # Increment index
    index=$((index + 1))
  done

  echo "✅ All attached policies imported successfully!"
fi




=============================

#!/bin/bash

role_name="my-iam-role"

# Fetch only customer-managed policy ARNs
policy_arns=$(aws iam list-attached-role-policies --role-name "$role_name" \
  --query "AttachedPolicies[?starts_with(PolicyArn, 'arn:aws:iam::')].PolicyArn" --output text)

# Check if any customer-managed policies are attached
if [ -z "$policy_arns" ]; then
  echo "⚠️ No customer-managed policies found for IAM role '$role_name'."
else
  echo "✅ Found customer-managed policies for IAM role '$role_name'. Importing..."
  
  index=0
  for policy_arn in $policy_arns; do
    echo "🔄 Importing policy attachment: $policy_arn"
    terraform import aws_iam_role_policy_attachment.customer_policy_attachments["$index"] "$role_name/$policy_arn"
    index=$((index + 1))
  done

  echo "✅ All customer-managed policies imported successfully!"
fi

