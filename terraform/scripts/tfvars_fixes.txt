variable "customer_managed_policies" {
  description = "A map of IAM policies with multiple statements"
  type = map(object({
    name        = string
    description = string
    statements  = list(object({
      Effect   = string
      Action   = list(string)
      Resource = string
      Sid      = optional(string)
    }))
  }))
}



resource "aws_iam_policy" "customer_managed" {
  for_each    = var.customer_managed_policies

  name        = each.value.name
  description = each.value.description

  policy = jsonencode({
    Version   = "2012-10-17"
    Statement = each.value.statements
  })
}


resource "aws_iam_role_policy_attachment" "customer_policy_attachments" {
  for_each   = aws_iam_policy.customer_managed

  policy_arn = each.value.arn
  role       = aws_iam_role.iam_role["enabled"].name
}

